# üß™ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —é–Ω–∏—Ç-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –º–æ–¥–µ–ª–µ–π –≤ Django

## üìò –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã –∏ –∑–∞–ø—É—Å–∫ —é–Ω–∏—Ç-—Ç–µ—Å—Ç–æ–≤ –¥–ª—è –º–æ–¥–µ–ª–µ–π Django-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –≤–∫–ª—é—á–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ—Å—Ç–æ–≤, –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å—Ä–µ–¥—ã, –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, —Ä–∞–±–æ—Ç—É —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏, –∞ —Ç–∞–∫–∂–µ –ø—Ä–∏–º–µ—Ä—ã.

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ

–¢–µ—Å—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–µ `tests/` –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

```

<app>/
‚îú‚îÄ‚îÄ models.py
‚îî‚îÄ‚îÄ tests/
‚îú‚îÄ‚îÄ **init**.py
‚îî‚îÄ‚îÄ test\_models.py

```

---

## ‚öôÔ∏è –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:

```

pip install pytest pytest-django

```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π–ª–∞ `pytest.ini`

–°–æ–∑–¥–∞–π—Ç–µ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ —Ñ–∞–π–ª `pytest.ini` —Ä—è–¥–æ–º —Å `manage.py`:

```

\[pytest]
DJANGO\_SETTINGS\_MODULE = event\_booking.settings
python\_files = tests/test\_\*.py
addopts = -ra -q

```

---

## üõ†Ô∏è –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∞–º–∏

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

### ‚úÖ 1. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:
```

python manage.py makemigrations

```

### ‚úÖ 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:
```

python manage.py migrate

```

> Django –ø—Ä–∏–º–µ–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ `pytest`.

---

## üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### üîπ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞:
```

pytest

```

### üîπ –¢–µ—Å—Ç—ã –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
```

pytest users/

```

### üîπ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª:
```

pytest booking/tests/test\_models.py

```

### üîπ –° verbose-–≤—ã–≤–æ–¥–æ–º:
```

pytest -v

````

---

## üîç –û–±—ä—è—Å–Ω–µ–Ω–∏–µ `@pytest.mark.django_db`

–í –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ë–î, –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä:

```python
@pytest.mark.django_db
````

–û–Ω —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥–µ–π—Å—Ç–≤–∏—è —Å ORM. –ë–µ–∑ –Ω–µ–≥–æ –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É:

```
django.db.utils.ProgrammingError: You must not use ORM inside a test without django_db
```

---

## üì¶ –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤ –º–æ–¥–µ–ª–µ–π

### üìÅ `users/tests/test_models.py`

```python
import pytest
from django.contrib.auth.models import User
from users.models import UserProfile

@pytest.mark.django_db
def test_user_profile_created():
    user = User.objects.create_user(username='jake', password='secret')
    profile = user.profile
    profile.telegram_chat_id = '123456'
    profile.save()

    assert profile.telegram_chat_id == '123456'
```

üîπ –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª `post_save`.

---

### üìÅ `events/tests/test_models.py`

```python
import pytest
from events.models import Event, Genre, City
from datetime import date, time

@pytest.mark.django_db
def test_event_creation():
    genre = Genre.objects.create(name='–ö–æ–Ω—Ü–µ—Ä—Ç')
    city = City.objects.create(name='–ú–æ—Å–∫–≤–∞')

    event = Event.objects.create(
        title='Test Event',
        event_date=date(2025, 6, 1),
        start_time=time(19, 0),
        location='–ö–ª—É–± XYZ',
        city=city,
        genre=genre,
        ticket_price=500,
        available_tickets=50
    )

    assert event.title == 'Test Event'
    assert event.city.name == '–ú–æ—Å–∫–≤–∞'
    assert event.genre.name == '–ö–æ–Ω—Ü–µ—Ä—Ç'
```

---

### üìÅ `booking/tests/test_models.py`

```python
import pytest
from django.contrib.auth.models import User
from events.models import Event, Genre, City
from booking.models import Booking, BookingStatus
from datetime import date

@pytest.mark.django_db
def test_booking_unique_constraint():
    user = User.objects.create_user(username='hacker', password='secret')
    genre = Genre.objects.create(name='–í—ã—Å—Ç–∞–≤–∫–∞')
    city = City.objects.create(name='–ü–∏—Ç–µ—Ä')
    event = Event.objects.create(
        title='HackConf',
        event_date=date(2025, 7, 1),
        location='Expo',
        city=city,
        genre=genre,
        ticket_price=1000,
        available_tickets=10
    )

    booking1 = Booking.objects.create(user=user, event=event)
    assert booking1.status == BookingStatus.BOOKED

    with pytest.raises(Exception):
        Booking.objects.create(user=user, event=event)  # –ø—Ä–æ–≤–µ—Ä–∫–∞ unique_together
```

---

### üìÅ `event_importer/tests/test_models.py`

```python
import pytest
from event_importer.models import EventSource, ImportLog

@pytest.mark.django_db
def test_event_source_and_log():
    source = EventSource.objects.create(
        name='RSS Parser',
        source_type='rss',
        url='https://example.com/events.xml'
    )

    log = ImportLog.objects.create(
        source=source,
        raw_data='<xml>sample</xml>',
        status='success'
    )

    assert log.source.name == 'RSS Parser'
    assert log.status == 'success'
```

---

## üìå –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

* ‚úÖ –ü–∏—à–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è (`test_<–º–æ–¥–µ–ª—å>_<–¥–µ–π—Å—Ç–≤–∏–µ>_<–æ–∂–∏–¥–∞–Ω–∏–µ>`)
* ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–π `tests/` –∫–∞–∫ –ø–∞–∫–µ—Ç (`__init__.py`), —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã
* ‚úÖ –†–∞–∑–¥–µ–ª—è–π `test_models.py`, `test_services.py`, `test_api.py`
* ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π `pytest.raises(...)` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

---

## üß† –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã

**–í: –ù—É–∂–Ω–æ –ª–∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—É—Å–∫–æ–º?**
**–û:** –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –º–µ–Ω—è–µ—à—å –º–æ–¥–µ–ª–∏. Django –ø—Ä–∏–º–µ–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ —Ç–µ—Å—Ç–æ–≤—É—é –ë–î —Å–∞–º.

**–í: –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–µ—Å—Ç–æ–≤–∞—è –ë–î?**
**–û:** Django —Å–æ–∑–¥–∞—ë—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –±–∞–∑—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, SQLite), –∞ –∑–∞—Ç–µ–º —É–¥–∞–ª—è–µ—Ç –µ—ë –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤.

**–í: –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è —Ñ–∏–∫—Å—Ç—É—Ä–∞?**
**–û:** –ò—Å–ø–æ–ª—å–∑—É–π `conftest.py` –∏ `@pytest.fixture`.

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —é–Ω–∏—Ç-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Django –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

* ‚úîÔ∏è –ü—Ä–æ–≤–µ—Ä–∫—É –ª–æ–≥–∏–∫–∏ –º–æ–¥–µ–ª–µ–π
* ‚úîÔ∏è –ó–∞—â–∏—Ç—É –æ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π
* ‚úîÔ∏è –ë—ã—Å—Ç—Ä—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `pytest` —É–ø—Ä–æ—â–∞–µ—Ç –∑–∞–ø—É—Å–∫ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –≤ –ª—é–±–æ–º CI-–ø–∞–π–ø–ª–∞–π–Ω–µ.

